
# x402-mock

> ğŸ“š åè®®å…¥é—¨ï¼š[ä»€ä¹ˆæ˜¯eip ercï¼Ÿ](./docs/what-is-eip-erc.cn.md)ï¼ˆ[é¢„ç•™è‹±æ–‡ç‰ˆ](./docs/what-is-eip-erc.en.md)ï¼‰

`x402-mock` æ˜¯ä¸€ä¸ªå®Œæ•´å®ç° **HTTP 402 çŠ¶æ€ç æ”¯ä»˜æµç¨‹** çš„ç”Ÿäº§çº§æ¨¡å—ã€‚

## æ¨¡å—åŠŸèƒ½

æœ¬æ¨¡å—å®Œæˆäº†åŸºäº **HTTP 402 Payment Required** çŠ¶æ€ç çš„å®Œæ•´ä»˜æ¬¾æµç¨‹ï¼Œå®ç°äº† Web2 HTTP åè®®ä¸ Web3 é“¾ä¸Šæ”¯ä»˜çš„æ— ç¼ç»“åˆã€‚

è¯¥æ¨¡å—é¢å‘ **Web3 + ERC20ï¼ˆUSDC ä¼˜å…ˆä¼˜åŒ–ï¼‰**ï¼Œå®Œæ•´å®ç°äº†ä»¥ä¸‹é“¾è·¯ï¼š

> **Clientï¼ˆè¯·æ±‚æ–¹ï¼‰â†’ Serverï¼ˆè¢«è¯·æ±‚æ–¹ï¼‰â†’ On-chain Settlementï¼ˆé“¾ä¸Šç»“ç®—ï¼‰**

æ ¸å¿ƒç‰¹æ€§ï¼š
- âœ… åŸºäº HTTP 402 çŠ¶æ€ç çš„æ ‡å‡†åŒ–æ”¯ä»˜åè®®
- âœ… **USDC ä¼˜åŒ–**ï¼šä» EIP-2612 å‡çº§ä¸º **ERC-3009ï¼ˆtransferWithAuthorizationï¼‰**ï¼Œä¸€æ­¥å®Œæˆæˆæƒä¸åˆ’è½¬ï¼Œæ›´çœ gas
- âœ… **é€šç”¨ ERC20**ï¼šæ”¯æŒ **Permit2ï¼ˆpermitTransferFromï¼‰**ï¼Œè®©å¤§å¤šæ•° ERC20 å…·å¤‡ç¦»çº¿ç­¾åæ”¯ä»˜èƒ½åŠ›
- âœ… å¼‚æ­¥é“¾ä¸Šç»“ç®—ï¼Œä¸é˜»å¡ä¸šåŠ¡æµç¨‹
- âœ… æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼åå•†ä¸åŒ¹é…
- ğŸ¤– é¢å‘ **Agent-to-Agent** è‡ªåŠ¨åŒ–æ”¯ä»˜åœºæ™¯è®¾è®¡

---

## é‡è¦è¯´æ˜ï¼ˆä¸ Coinbase ç‰ˆæœ¬å·®å¼‚ï¼‰

- æœ¬å®ç°ä¸ä½¿ç”¨ facilitator/ä»£ä»˜æœåŠ¡ï¼šé“¾ä¸Šç»“ç®—äº¤æ˜“ç”±è¿è¡Œæ–¹è‡ªè¡Œå¹¿æ’­ï¼Œå› æ­¤ **gas ç”±è¿è¡Œæ–¹æ‰¿æ‹…**ï¼Œå¹¶éœ€è¦æä¾›å¯ç”¨çš„ **RPC/Infra Key**ï¼ˆå¦‚ Infura/Alchemy ç­‰ï¼‰ã€‚
- æ”¯æŒç™½åå•æ¨¡å¼ï¼šè°ƒç”¨æ–¹å¯æºå¸¦è‡ªå®šä¹‰çš„ **`authorization key`**ï¼Œç”±æœåŠ¡ç«¯æ ¡éªŒåæ‰å…è®¸è®¿é—®éœ€è¦æ”¶è´¹çš„ APIï¼ˆå¯åœ¨è¿›å…¥ 402/æ”¯ä»˜æµç¨‹å‰è¿›è¡Œæ‹¦æˆªï¼‰ã€‚

---

## è®¾è®¡ç›®æ ‡

- ğŸ§ª **æµç¨‹ä¼˜å…ˆ**ï¼šå…³æ³¨ x402 çš„äº¤äº’ä¸è¯­ä¹‰ï¼Œè€Œéå·¥ç¨‹å®Œå¤‡æ€§  
- ğŸ§  **å¯ç†è§£æ€§**ï¼šå°½é‡å‡å°‘éšè—é€»è¾‘ï¼Œæ–¹ä¾¿é˜…è¯»ä¸å­¦ä¹   
- ğŸ¤– **é¢å‘ Agent**ï¼šä¸ºæœªæ¥ Agent è‡ªåŠ¨å‘èµ· / æ¥å— / æ‰§è¡Œæ”¯ä»˜åšå‡†å¤‡  
- ğŸ”Œ **å¯æ‰©å±•æ€§**ï¼šåç»­å¯è‡ªç„¶æ¼”è¿›ä¸ºå¤šé“¾ã€å¤šèµ„äº§ã€å¤šæ”¯ä»˜é€šé“  

---

## å®Œæ•´äº¤äº’æµç¨‹

### 1. åˆå§‹è¯·æ±‚ï¼ˆæœªæˆæƒï¼‰

**Client** å‘ **Server** çš„æ”¶è´¹ç«¯å£å‘èµ· GET è¯·æ±‚ï¼Œè¯·æ±‚æ—¶æºå¸¦ç©ºçš„æˆ–é”™è¯¯çš„ `Authorization` headerã€‚

**Server** æ£€æµ‹åˆ°æœªæˆæƒï¼Œè¿”å› `402 Payment Required` çŠ¶æ€ç ï¼Œå¹¶åœ¨å“åº”ä½“ï¼ˆpayloadï¼‰ä¸­åŒ…å«ï¼š
- `access_token_endpoint`ï¼šè·å–è®¿é—®ä»¤ç‰Œçš„ç«¯å£åœ°å€
- `payment_methods`ï¼šæ”¯æŒçš„æ”¶æ¬¾æ–¹å¼åˆ—è¡¨ï¼ˆå¦‚ EVM/USDCã€SVM/USDC ç­‰ï¼‰

### 2. æ”¯ä»˜æ–¹å¼åŒ¹é…ä¸ç­¾å

**Client** æ”¶åˆ° 402 å“åº”åï¼š
1. æ ¹æ®è‡ªå·±æ”¯æŒçš„ä»˜æ¬¾æ–¹å¼ï¼Œä¸ Server æä¾›çš„æ”¶æ¬¾æ–¹å¼è¿›è¡Œ**åŒ¹é…**
2. é€‰æ‹©åŒ¹é…çš„æ”¯ä»˜æ–¹å¼ï¼ˆå¦‚ EVM + USDCï¼‰
3. ä½¿ç”¨é’±åŒ…ç§é’¥å¯¹æ”¯ä»˜ä¿¡æ¯è¿›è¡Œ**ç¦»çº¿ç­¾å**ï¼ŒæŒ‰å¸ç§ç”Ÿæˆå¯¹åº”çš„ç­¾åå‡­è¯ï¼š
   - **USDC**ï¼šç”Ÿæˆ **ERC-3009 Authorization**ï¼ˆç”¨äºé“¾ä¸Š `transferWithAuthorization`ï¼‰
   - **å…¶ä»– ERC20**ï¼šç”Ÿæˆ **Permit2** ç­¾åï¼ˆç”¨äºé“¾ä¸Š `permitTransferFrom`ï¼‰

### 3. æäº¤ç¦»çº¿ç­¾åå‡­è¯è·å–è®¿é—®ä»¤ç‰Œ

**Client** å°†ç”Ÿæˆçš„ç­¾åå‡­è¯ï¼ˆauthorization/permitï¼‰æ”¾å…¥è¯·æ±‚ä½“ï¼ˆbodyï¼‰ï¼Œå‘ `access_token_endpoint` å‘èµ· POST è¯·æ±‚ã€‚

**Server** æ”¶åˆ°ç­¾åå‡­è¯åï¼Œè¿›è¡Œä»¥ä¸‹éªŒè¯ï¼ˆå­—æ®µä¼šå›  ERC-3009 / Permit2 è€Œç•¥æœ‰å·®å¼‚ï¼‰ï¼š
- âœ… **sender/owner**ï¼ˆä»˜æ¬¾åœ°å€ï¼‰æ˜¯å¦ä¸ç­¾åè€…ä¸€è‡´
- âœ… **receiver/spender**ï¼ˆæ”¶æ¬¾åœ°å€ï¼‰æ˜¯å¦ä¸º Server æŒ‡å®šçš„åœ°å€
- âœ… **æœ‰æ•ˆæœŸ**ï¼ˆvalid_before/deadline ç­‰ï¼‰æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
- âœ… **nonce** æ˜¯å¦æœªè¢«ä½¿ç”¨ï¼ˆé˜²é‡æ”¾ï¼‰
- âœ… **signature**ï¼ˆç­¾åï¼‰æ˜¯å¦åˆæ³•
- âœ… **ä½™é¢/æˆæƒé¢åº¦** æ˜¯å¦å……è¶³

éªŒè¯é€šè¿‡åï¼š
- ç«‹å³è¿”å› `access_token` ç»™ Client
- åŒæ—¶è§¦å‘**å¼‚æ­¥é“¾ä¸Šç»“ç®—**ï¼ˆå› ä¸ºåŒºå—é“¾äº¤æ˜“é€Ÿåº¦è¾ƒæ…¢ï¼Œé‡‡ç”¨å¼‚æ­¥å¤„ç†é¿å…é˜»å¡ï¼‰

### 4. ä½¿ç”¨è®¿é—®ä»¤ç‰Œè·å–èµ„æº

**Client** æ”¶åˆ° `access_token` åï¼š
- å°† `access_token` æ”¾å…¥ `Authorization` header
- é‡æ–°å‘æ”¶è´¹ç«¯å£å‘èµ· GET è¯·æ±‚
- **Server** éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§åï¼Œè¿”å›è¯·æ±‚çš„èµ„æºï¼Œå®Œæˆäº¤äº’

### 5. é“¾ä¸Šå¼‚æ­¥ç»“ç®—

**Server** åœ¨åå°æ ¹æ®ç­¾åç±»å‹æ‰§è¡Œé“¾ä¸Šç»“ç®—ï¼š
- **USDC**ï¼šè°ƒç”¨ `transferWithAuthorization`ï¼ˆERC-3009ï¼‰å®Œæˆèµ„é‡‘è½¬ç§»ï¼ˆç›¸æ¯” EIP-2612 çš„ä¸¤æ­¥è°ƒç”¨æ›´çœ gasï¼‰
- **å…¶ä»– ERC20**ï¼šè°ƒç”¨ Uniswap Permit2 çš„ `permitTransferFrom` å®Œæˆèµ„é‡‘è½¬ç§»ï¼ˆè¦†ç›–å¤§å¤šæ•° ERC20 çš„ç¦»çº¿ç­¾åæ”¯ä»˜ï¼‰

ç»“ç®—ç»“æœå¯é€šè¿‡äº¤æ˜“å“ˆå¸Œï¼ˆtx_hashï¼‰åœ¨åŒºå—é“¾æµè§ˆå™¨ä¸ŠæŸ¥è¯¢ã€‚

---

## æµç¨‹å›¾

> ğŸ“Œ å®Œæ•´äº¤äº’æµç¨‹ç¤ºæ„å›¾è¯·å‚è€ƒä¸‹å›¾  
> [å›¾ç‰‡](.//assets/402workflow.png)

---

## ç¯å¢ƒé…ç½®

### ä¾èµ–å®‰è£…

æœ¬é¡¹ç›®ä½¿ç”¨ `uv` ä½œä¸ºåŒ…ç®¡ç†å·¥å…·ã€‚è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š

```bash
uv add x402-mock
uv sync
```
[**æ–‡æ¡£åœ°å€**](https://openpayhub.github.io/x402-mock/)

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨é¡¹ç›®**æ ¹ç›®å½•**åˆ›å»º `.env` æ–‡ä»¶ï¼Œæˆ–é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

#### å¿…éœ€é…ç½®

- **`EVM_PRIVATE_KEY`**ï¼ˆå¿…é¡»ï¼‰  
  é’±åŒ…çš„ç§é’¥ï¼Œç”¨äºç­¾åå’Œé“¾ä¸Šäº¤æ˜“ã€‚**è¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²ï¼**

#### å¯é€‰é…ç½®

- **`EVM_INFURA_KEY`**ï¼ˆå¯é€‰ï¼‰  
  Infura API Keyï¼ˆæˆ–æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ RPC/Infra Provider Keyï¼‰ã€‚ç”±äºæœ¬å®ç°ä¸ä½¿ç”¨ facilitator/ä»£ä»˜æœåŠ¡ï¼Œç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®æä¾›ç¨³å®šçš„ RPCï¼Œå¦åˆ™å°†ä½¿ç”¨å…¬å…±èŠ‚ç‚¹ï¼ˆé€Ÿåº¦å’Œç¨³å®šæ€§å¯èƒ½è¾ƒå·®ï¼‰ã€‚

> ğŸ’¡ æœªæ¥å°†å¢åŠ æ›´å¤šå‚æ•°æ”¯æŒï¼Œå¦‚ `SVM_PRIVATE_KEY` ç­‰ã€‚

ç¤ºä¾‹ `.env` æ–‡ä»¶ï¼š

```env
EVM_PRIVATE_KEY=your_private_key_here
EVM_INFURA_KEY=your_infura_key_here  # å¯é€‰
```

### ç½‘ç»œé€‰æ‹©å»ºè®®

**ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œå¼ºçƒˆå»ºè®®å…ˆåœ¨æµ‹è¯•ç½‘è¿›è¡Œå……åˆ†æµ‹è¯•ï¼š**

- **æµ‹è¯•ç½‘æ¨è**ï¼šSepoliaï¼ˆä»¥å¤ªåŠï¼‰ã€Mumbaiï¼ˆPolygonï¼‰ç­‰
- **æµ‹è¯•èµ„äº§**ï¼šå¯é€šè¿‡å„é“¾å®˜æ–¹ Faucet å…è´¹é¢†å–æµ‹è¯• ETH å’Œæµ‹è¯• USDC
- **éªŒè¯æµç¨‹**ï¼šç¡®è®¤å®Œæ•´æ”¯ä»˜æµç¨‹ã€é“¾ä¸Šç»“ç®—ã€å¼‚å¸¸å¤„ç†ç­‰åŠŸèƒ½æ­£å¸¸

æµ‹è¯•é€šè¿‡åï¼Œå¯åˆ‡æ¢åˆ°ä¸»ç½‘è¿›è¡Œç”Ÿäº§éƒ¨ç½²ã€‚

---

## ä½¿ç”¨ç¤ºä¾‹

### Server ç«¯æœ€ç®€å•ä»£ç ç¤ºä¾‹

```python
# Server æœ€ç®€å•ç«¯ç¤ºä¾‹ä»£ç 
from x402_mock.servers import Http402Server, create_private_key

token_key = create_private_key() # æœåŠ¡ç«¯ç­¾åç§é’¥ï¼Œç”¨äºå¯¹ access_token è¿›è¡Œç­¾å‘å’ŒéªŒè¯ï¼ˆéåŒºå—é“¾é’±åŒ…ç§é’¥ï¼Œå¯ç”±é…ç½®æä¾›ï¼‰

app = Http402Server(
  token_key=token_key,
  token_expires_in=300 # access_tokenåˆ°æœŸç§’æ•°
)
app.add_payment_method(
    chain_id="eip155:11155111",
    amount=0.5,
    currency="USDC",
) # æ¥å—çš„æ”¶æ¬¾æ–¹å¼

@app.get("/api/protected-data") # ä½¿ç”¨æ–¹å¼ç»§æ‰¿fastapi
@app.payment_required # åªè¦æœ‰è¯¥è£…é¥°å™¨ï¼Œå°±ä»£è¡¨è¯¥ç«¯å£æ”¶è´¹ã€‚
async def get_protected_data(authorization):
    """This endpoint requires payment to access."""
    # è¿™é‡Œå¯ä»¥å†™ç«¯å£é€»è¾‘
    return {
        "message": "Payment verified successfully",
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="localhost", port=8000)

```

### Client ç«¯æœ€ç®€å•ä»£ç ç¤ºä¾‹

```python
from x402_mock.clients.http_client import Http402Client
from x402_mock.adapters.adapters_hub import AdapterHub

wpk = "your eoa private key"
ah = AdapterHub(wpk)

async with Http402Client() as client: # ä½¿ç”¨æ–¹å¼ç»§æ‰¿httpxï¼Œ
  clinet.add_payment_method(
            chain_id="eip155:11155111",
            amount=0.8, # é™åˆ¶ä»˜æ¬¾é‡‘é¢
            currency="USDC"
        ) # å¢åŠ ä»˜æ¬¾æ–¹å¼ï¼Œå…ˆè®¾ç½®çš„ä»˜æ¬¾æ–¹å¼ä¼˜å…ˆåŒ¹é…ã€‚
  await ah.initialize(client_role=True)  # Initialize adapters for client role (pre-signing setup)
  response = client.get("http://localhost:8000/api/protected-data") # è¯·æ±‚èµ„æºç«¯å£

```
* ä»£ç ç¤ºä¾‹:
[ç¤ºä¾‹example](./example/)


---

## å½“å‰çŠ¶æ€

* âœ… å®Œæ•´çš„ HTTP 402 æ”¯ä»˜æµç¨‹
* âœ… Client â†’ Server è¯·æ±‚ä¸å“åº”
* âœ… æ”¯ä»˜æ–¹å¼åå•†ä¸åŒ¹é…
* âœ… USDCï¼šERC-3009 ç¦»çº¿ç­¾åä¸éªŒè¯ï¼ˆæ›´çœ gasï¼‰
* âœ… é€šç”¨ ERC20ï¼šPermit2 ç¦»çº¿ç­¾åä¸éªŒè¯ï¼ˆè¦†ç›–å¤§å¤šæ•° ERC20ï¼‰
* âœ… é“¾ä¸Š USDC è½¬è´¦ï¼Œtx_hash å¯æŸ¥
* âœ… å¼‚æ­¥é“¾ä¸Šç»“ç®—ï¼Œä¸é˜»å¡ä¸šåŠ¡
* ğŸš€ ç”Ÿäº§çº§å¯è¿è¡Œå®ç°

---

## Roadmap

* [ ] è¦†ç›– EVM é“¾ï¼ˆEthereumã€Polygonã€Arbitrumã€Optimism ç­‰ï¼‰
* [ ] æ”¯æŒ æ™ºèƒ½åˆçº¦é’±åŒ…åœ°å€æ”¶æ¬¾
* [ ] æ”¯æŒ EIP-6492ï¼ˆæœªéƒ¨ç½²åˆçº¦çš„ç­¾åéªŒè¯ï¼‰
* [ ] æ”¯æŒ SVMï¼ˆSolana Virtual Machineï¼‰åŠ Solana ç”Ÿæ€

---

## å£°æ˜ä¸å»ºè®®

æœ¬æ¨¡å—å·²è¾¾åˆ°ç”Ÿäº§å¯ç”¨çº§åˆ«ï¼Œä½†åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼Œè¯·æ³¨æ„ï¼š

âš ï¸ **å¼ºçƒˆå»ºè®®å…ˆåœ¨æµ‹è¯•ç½‘ï¼ˆå¦‚ Sepoliaï¼‰è¿›è¡Œå……åˆ†æµ‹è¯•**  
âœ… ç¡®è®¤å®Œæ•´æ”¯ä»˜æµç¨‹ã€å¼‚å¸¸å¤„ç†ã€é“¾ä¸Šç»“ç®—ç­‰åŠŸèƒ½ç¬¦åˆé¢„æœŸ  
ğŸ”’ å¦‚ç”¨äºçœŸå®èµ„äº§ï¼Œè¯·åŠ¡å¿…å®Œæˆå®‰å…¨å®¡è®¡ä¸é£é™©æ§åˆ¶  
ğŸ’° å»ºè®®è®¾ç½®åˆç†çš„å•ç¬”äº¤æ˜“é™é¢å’Œé£æ§æœºåˆ¶

---

å¦‚æœä½ åœ¨ç ”ç©¶ï¼š

* x402 åè®®
* Agent ç»æµç³»ç»Ÿ
* è‡ªåŠ¨åŒ–é“¾ä¸Šæ”¯ä»˜

æ¬¢è¿äº¤æµä¸å…±å»ºã€‚

